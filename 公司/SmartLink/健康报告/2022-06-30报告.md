# 2022-06-30报告

## 服务器地址

4G内存
10.60.249.10、10.60.249.11、10.60.249.6、10.60.249.7

### 内存使用

`2022-06-23` ~ `2022-06-30`

![2022-06-30报告-内存](vx_images/383994416220671.png)

每台机器平均每天 FGC 4 次左右.
因考虑到业务场景有的账号下面车辆就很多,查询报表或者导出的情况可能产生大对象直接落老年代.

解决方案:尽可能后面编码的时候注意,比如在方法中使用完大对象手动赋值 null,而不是等一个方法执行完,因为根可达算法栈帧中本地变量表会扫描到等等.


## 消息堆积

目前消息堆积主要出现在合并后的 topic.堆积严重.
Topic:yk-t-cld-ms-transferAdapt-130

![2022-06-30-消息堆积](vx_images/212381017239097.png)

目前会出现 ack 提交超时,运维说明可能是 IO 问题导致,已经在申请资源中.
怀疑还是消费速度跟不上生产速度.(IO 问题导致 ack 提交速度慢).

![2022-06-30-消费速度](vx_images/171811317226964.png)

针对消费速度解决方案: 可以使用 Consumer 批量消费消息,提高消费速度降低提交 ack 频次.并且再内部优化下处理逻辑代码.然后在观察看看.

## 慢 sql

慢 sql 中主要体现以下几张表: a_message_yyyy_dd(分表每月百万级)、eop_travels_detail(千万级)、oil_change(千万级)、car_driving_analysis、e_risk_yyyy_dd、b_day_statistics_yyyy_dd(百万级)

解决方案: 看这几张表中索引是否设置合理，如合理查看代码中涉及到的 sql 看有无命中。如遇到 join 看是否可以拆开通过主键多查几次。有的表看是否可以进行归档。

## error 日志

常出现的 error

```json
com.faw.smart.team.filter.UCAuthFilter   : - Json处理异常 || 非UserInfo格式 || parameter: maps2:{"principal":{"groupsId":"18682,36682,37260","userStatus":0,"userSource":0,"firstGroupsInfo":[{"groupsName":"深圳盛田的车队","id":18682},{"groupsName":"[GDQK37]惠州市益华汽车销售有限公司(中重卡/轻卡)","id":36682},{"groupsName":"[GDQK45]深圳市盛田汽车销售有限公司(中重卡/轻卡)","id":37260}],"credentialsNonExpired":true,"mobile":"13068718686","superManage":0,"headPic":"","authorities":[{"authority":"35971","userId":13090,"elemCodes":"1"}],"enabled":true,"password":"$2a$10$E8k0zYr7x7wbJcTzrUDuO.I.IU8P5YUBE7eyIM7D3dEjcaHZGFfZy","loginTime":1655975863408,"appId":31,"joinType":0,"nickname":"深圳盛田","accountNonExpired":true,"id":13090,"originalId":"0","username":"13068718686","accountNonLocked":true},"authenticated":true,"clientOnly":false,"credentials":"","userAuthentication":{"principal":{"groupsId":"18682,36682,37260","userStatus":0,"userSource":0,"firstGroupsInfo":[{"groupsName":"深圳盛田的车队","id":18682},{"groupsName":"[GDQK37]惠州市益华汽车销售有限公司(中重卡/轻卡)","id":36682},{"groupsName":"[GDQK45]深圳市盛田汽车销售有限公司(中重卡/轻卡)","id":37260}],"credentialsNonExpired":true,"mobile":"13068718686","superManage":0,"headPic":"","authorities":[{"authority":"35971","userId":13090,"elemCodes":"1"}],"enabled":true,"password":"$2a$10$E8k0zYr7x7wbJcTzrUDuO.I.IU8P5YUBE7eyIM7D3dEjcaHZGFfZy","loginTime":1655975863408,"appId":31,"joinType":0,"nickname":"深圳盛田","accountNonExpired":true,"id":13090,"originalId":"0","username":"13068718686","accountNonLocked":true},"authenticated":true,"credentials":"d841cac1c6d087b595a3ee73a2555217","name":"13068718686","details":{"password":"d841cac1c6d087b595a3ee73a2555217","clientId":"86abc286819446e8b5ef01bb7a09b679","grant_type":"password","username":"13068718686"},"authorities":[{"authority":"35971","userId":13090,"elemCodes":"1"}]},"name":"13068718686","details":{"tokenType":"Bearer","tokenValue":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NTY4Mzk4NjMsInVzZXJfbmFtZSI6IjEzMDY4NzE4Njg2IiwiYXV0aG9yaXRpZXMiOlsiMzU5NzEiXSwianRpIjoiOWM3OTkwZjctYmIxMS00ZDY1LWE3ZjEtZjk2MTU1ZWVlNTdiIiwiY2xpZW50X2lkIjoiODZhYmMyODY4MTk0NDZlOGI1ZWYwMWJiN2EwOWI2NzkiLCJzY29wZSI6WyJhbGwiXX0.o41lC85_oXnNx9w5V8CpMJhEyl3rNPoE3Uh4_CMgU3c","remoteAddress":"10.60.238.66"},"authorities":[{"authority":"35971","userId":13090,"elemCodes":"1"}],"oauth2Request":{"responseTypes":[],"approved":true,"extensions":{},"clientId":"86abc286819446e8b5ef01bb7a09b679","scope":["all"],"requestParameters":{"grant_type":"password","username":"13068718686"},"refresh":false,"grantType":"password","authorities":[],"resourceIds":[]}}, eMessage:parseInt error, field : groupsId
```

```json
Mapper method 'com.faw.smart.team.api.dao.mapper.RiskEventMapper.queryMonthCount attempted to return null from a method with a primitive return type (int).
```

```json
m.faw.smart.team.service.BaseInfoService : - 批量删除终端错误！
org.springframework.web.client.HttpServerErrorException$BadGateway: 502 Bad Gateway
```

```json
m.faw.smart.team.service.AlarmSetService : - 加车初始化车辆报警异常    
```