# 运营分析报告详设

## 数据建模

可以复用当前定时任务，任务handler: `carMonthlyStatisticsJobHandler`，任务描述: 车辆每日行驶数据。

涉及数据表`b_day_statistics_yyyy_MM`根据每月来分表，根据车辆维度来固化数据，车队有多少台车每日就会新增多少数据。

```sql
CREATE TABLE b_day_statistics_2020_10
(
    id                      INT AUTO_INCREMENT
        PRIMARY KEY,
    car_id                  INT                                NULL COMMENT '车辆id',
    odo_mileage             DOUBLE                             NULL COMMENT '总里程',
    trip_mileage            DOUBLE                             NULL COMMENT '根据0200结果精准后的里程 单位:米',
    avg_speed               DOUBLE                             NULL COMMENT '平均速度单位:(100*M/S)',
    drive_avg_speed         DOUBLE                             NULL COMMENT '驾驶平均速度 单位:米/秒',
    idle_fuel               DOUBLE                             NULL COMMENT '怠速油耗 单位:毫升',
    oil                     DOUBLE                             NULL COMMENT '油耗',
    fuel100km               DOUBLE                             NULL COMMENT '百公里油耗，单位:升/100千米',
    trip_duration           DOUBLE                             NULL COMMENT '行程时长 单位:秒 （行程结束时间-开始时间）= 引擎工作时长engineWorkTime',
    idle_duration           DOUBLE                             NULL COMMENT '怠速时长 单位:秒',
    trip_urea               DOUBLE                             NULL COMMENT '累计尿素喷射量,单位：g',
    vehicle_utilization_per DOUBLE                             NULL,
    fuel_consumption_per    DOUBLE                             NULL,
    day                     VARCHAR(20)                        NULL,
    create_time             DATETIME DEFAULT CURRENT_TIMESTAMP NULL,
    update_time             DATETIME DEFAULT CURRENT_TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,
    brake_number            INT                                NULL COMMENT '刹车次数',
    brake_times             DOUBLE                             NULL COMMENT '刹车时间',
    brake_mil               DOUBLE                             NULL COMMENT '刹车里程/单位m'
)
    CHARSET = utf8mb4;

CREATE INDEX idx_car_id
    ON b_day_statistics_2020_10 (car_id);

CREATE INDEX idx_day
    ON b_day_statistics_2020_10 (day);
    
#v2.9本本新增字段
trip_cost               DOUBLE      DEFAULT 0                 NOT NULL COMMENT '行驶成本',
trip_score              DOUBLE      DEFAULT 0                 NOT NULL COMMENT '驾驶评分'
team_code               VARCHAR(64)                           NULL COMMENT '机构号'
```

## 系统业务模型

```java
@Data
public class TruckPerTripDataBO {

    /**
     * 车辆id
     */
    private Integer carId;
    /**
     * 车牌号
     */
    private String carNo;
    /**
     * 车辆tid
     */
    private String tid;
    /**
     * 驾驶评分
     */
    private Double tripScore;
    /**
     * 行驶里程
     */
    private Double tripMileage;
    /**
     * 耗油量
     */
    private Double oilConsumption;
    /**
     * 行驶时长
     */
    private Double tripDuration;
    /**
     * 怠速时长
     */
    private Double idleDuration;
    /**
     * 行驶成本
     */
    private Double tripCost;
}
```

## 请求接口根URI

> 根URI: /report/operation/analysis

## 条件查询

> 1. 筛选项：所属机构、报告类型（自定义时间、周报、日报）。
>
> 2. 时间范围`最多查询一年内的数据`如开始时间小于一年前的当前时间则不给查询。自定义时间则是`跨度最大三个月`。
>
> 3. 默认进入页面展示账号对应的机构上一周周报数据，如`顶级机构`则不查询，必须选择机构给予查询。

## 整体数据概览

| 展示描述                 | 数据源                                                       |
| ------------------------ | ------------------------------------------------------------ |
| 车辆数                   | 获取每个机构下的车辆数                                       |
| 平均驾驶评分             | 根据现有驾驶评分数据获取                                     |
| `行驶里程`               | 根据现有位置云接口获取 /faw/rest/location/milcon/queryByDay  |
| 平均单车里程             | 根据行驶里程计算得出                                         |
| `耗油量|耗气量`          | 根据现有位置云接口获取 /faw/rest/location/milcon/queryByDay  |
| 平均单车耗油量\|耗气量   | 根据总的耗油量\|耗气量计算得出                               |
| 平均百公里耗油量\|耗气量 | 根据总的耗油量\|耗气量和行驶里程计算得出                     |
| `运营时长`               | 根据现有位置云接口获取 /faw/rest/location/milcon/queryByDay  |
| 平均单车运营时长         | 根据总运营时长计算得出                                       |
| 平均车速                 | ？                                                           |
| `怠速时长`               | 根据现有位置云接口获取 /faw/rest/location/milcon/queryByDay  |
| 平均单车怠速时长         | 根据总怠速时长计算得出                                       |
| 总成本                   | 根据 eop_travels_detail(路桥成本)、refueling_cost(加油成本)、maintenance_cost(维保成本)、miscellaneous_expenses(杂项成本)四张表查询得出 |
| 平均单车成本             | 根本总成本计算得出                                           |
| 平均公里成本             | 根本总里程和总成本计算得出                                   |

以上基础数据直接持久化落库比如：车辆数，驾驶评分总分、行驶里程、耗油量|耗气量、运营时长、怠速时长、总成本。以供页面查询接口查询基础数据计算出值。

**再上面固化数据基础上，还会增加固化`成本`、`公里成本`、`驾驶评分`用于以下制图展示。**

## 变化趋势

> 只有周、月查询才展示!

### 总里程

查询出近六周的总里程数据进行展示。

### 百公里油耗

查询出近六周的总油耗、总行驶里程进行计算展示。

### 怠速时长

查询出近六周的怠速数据进行展示。

### 平均车速

查询出近六周的平均车速数据进行展示。

***变化趋势这四个折线图都属于基础数据，在固化的时候就可以拿到并存储。***

## 车辆运营统计

> 所有折线图都是根据车辆来的，所以都需要在`页面查询`的时候`查询出符合条件`的数据。
>
> `聚合查询`机构下`近六周/月`的符合条件的数据。
>
> `右开左闭`规则进行数据筛选。

### 行驶里程(辆)

**查询逻辑: **

1. `<`1.2W
2. 1.2`~`1.4W
3. 1.4`~`1.6W
4. 1.6`~`1.8W
5. 1.8`~`2W
6. `>`2w

***根据查询时间范围内所属机构下的所有车辆行驶里程信息进行统计。***

### 百公里油耗(辆)

1. `<`28L
2. 20`~`30L
3. 30`~`32L
4. 32`~`34L
5. 34`~`36L
6. 36`~`38L
7. `>`38L

***根据查询时间范围内所属机构下的所有车辆总油耗和总行驶里程信息进行统计。***

### 怠速时长(辆)

1. `<`5h
2. 5`~`10h
3. 15`~`20h
4. 20`~`25h
5. 25`~`30h
6. `>`30h

***根据查询时间范围内所属机构下的所有车辆怠速时长信息进行统计。***

### 平均车速(辆)



## 车辆行驶趋势

> 柱状图&折线图都是根据车辆来统计的。

### 每日车辆出勤情况

根据定时任务固化的数据查出时间范围内所有行驶里程`>`0的车辆数、和时间范围内所有记录数计算得出数据返回给前端。

### 里程&油耗趋势

根据定时任务固化的`里程`、`油耗`，查询出对应时间范围内的数据返回给前端。

### 怠速时长&油耗占比趋势

根据定时任务固化的`怠速时长`、`怠速油耗`，查询出对应时间范围内的数据返回给前端。

### 平均速度&百公里能耗趋势

根据定时任务固化的`车辆平均速度`，`总油耗`、`总里程`查询出对应时间范围内的数据返回给前端。

### 行驶时间分布（h）

<font color="red">**暂不支持...**</font>

## 车辆排名及差异分析

### 百公里油耗排名（L/1000KM）

根据定时任务固化的单车`总油耗`、`总里程`、`公里成本`数据，可以查询出对应时间范围内前10&后10辆车，用于返回前端。

### 公里成本排名（元/KM）

根据定时任务固化的单车`百公里油耗`、`公里成本`数据，可以查询出对应时间范围内前10&后10辆车，用于返回前端。

### 百公里油耗差异分析

根据定时任务固化的单车`百公里油耗`、`公里成本`数据,显示所选机构在所选时间里油耗水平最低（3辆）和最高的（3辆车）进行分析。

调用位置云对应接口`/rest-kudu/location/trip/statistics/query`用于展示。

[gear 档位信息],[rpm 发动机转速信息],[speed 速度信息],[base 行程基础信息],[extend 行程扩展信息],[accelerator 油门开度信息],[accspeed 加速度信息],[slope 坡度信息],[accelerator_change 油门变化区间],[speed_statistics 车速区间]。

### 即将保养车辆

查询对应affairs_alarm（车务提醒表）可以查询出对应需要保养的车辆信息，再根据车辆信息去位置云获取当前里程信息，用于返回前端。