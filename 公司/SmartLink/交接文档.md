# 交接文档

## 安全分析报告

### 数据库

```sql
team_safety_statistics
```

### 涉及代码

```java
/**
 * smart-team-jobs
 * 安全分析报告数据处理 handler
 */
public class SafetyDataProcessHandler {
    // 定时任务固化前一天数据至 `team_safety_statistics` 表中
    @XxlJob("safetyDataProcessHandler")
    @JobLog(desc = "安全报告数据每日固化", bean = "safetyDataProcessHandler")
    public ReturnT<String> safetyDataProcess(String param) throws Exception {
        if (log.isInfoEnabled()) {
            log.info("安全分析报告数据处理任务执行开始.param:[{}]", param);
        }
        try {
            safetyDataProcessService.safetyDataProcess(param);
            if (log.isInfoEnabled()) {
                log.info("安全分析报告数据处理任务执行结束.");
            }
            return ReturnT.SUCCESS;
        } catch (Exception e) {
            if (log.isErrorEnabled()) {
                log.error("安全分析报告数据处理任务执行失败.", e);
            }
            throw e;
        }
    }
}

/**
 * smart-team-core
 */
@RestController
@RequestMapping(value = "risk/analysis")
public class RiskAnalysisController {
    /**
     * smart-team-core
     * 针对定时任务固化的表进行查询数据聚合
     */
    @PostMapping("/safety")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER250)
    @ApiOperation(value = "安全分析报告", authorizations = {@Authorization(value = "Auth-Token")})
    public Single<SafetyAnalysisDTO> getSafetyReport(@RequestBody SafetyAnalysisQueryVo vo) {
        return safetyAnalysisService.getSafetyReport(vo);
    }
}
```

## 运营分析报告

### 数据库

```sql
# 按月分表
b_day_statistics_2022_08
```

### 涉及代码

```java
/**
 * smart-team-jobs
 * 车辆每日行驶数据JobHandler
 */
public class CarMonthlyStatisticsJobHandler {
    // 定时任务固化前一天数据至 `b_day_statistics_2022_08` 表中
    @XxlJob("carMonthlyStatisticsJobHandler")
    @JobLog(desc = "车辆每日行驶数据固化", bean = "carMonthlyStatisticsJobHandler")
    public ReturnT<String> carMonthlyStatisticsJobHandler(String param) throws Exception {
        log.info("XXL-JOB, CarMonthlyStatisticsJobHandler start.");
        carDayAndMonthStatisticsBuildService.buildData(param);
        log.info("XXL-JOB, CarMonthlyStatisticsJobHandler end.");
        return ReturnT.SUCCESS;
    }
}

/**
 * smart-team-core
 * 针对定时任务固化的表进行查询数据聚合
 */
@RequestMapping(value = "/report/operation/analysis")
@RequiredArgsConstructor
public class OperationAnalysisController {
    @PostMapping("/ring/view")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER290)
    @ApiOperation(value = "运营分析报告概览数据", authorizations = {@Authorization(value = "Auth-Token")})
    public Single<OperationAnalysisDTO> ringView(@RequestBody @Validated OperationAnalysisQueryVo vo) {
        return analysisService.ringView(vo);
    }

    @PostMapping("/change/chart")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER290)
    @ApiOperation(value = "运营分析报告变化趋势", authorizations = {@Authorization(value = "Auth-Token")})
    public Response<OperationAnalysisDTO> changeChart(@RequestBody @Validated OperationAnalysisQueryVo vo) {
        return ResponseHelper.createSuccessResponse(analysisService.changeChart(vo));
    }

    @PostMapping("/truck/trip/statistics")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER290)
    @ApiOperation(value = "运营分析报告行车趋势", authorizations = {@Authorization(value = "Auth-Token")})
    public Single<OperationAnalysisDTO> truckTripStatistics(@RequestBody @Validated OperationAnalysisQueryVo vo) {
        return analysisService.truckTripStatistics(vo);
    }

    @PostMapping("/operation/statistics")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER290)
    @ApiOperation(value = "运营分析报告-车辆运营统计", authorizations = {@Authorization(value = "Auth-Token")})
    public Response<OperationAnalysisDTO> operationStatistics(@RequestBody @Validated OperationAnalysisQueryVo vo) throws ExecutionException, InterruptedException {
        return ResponseHelper.createSuccessResponse(analysisService.operationStatistics(vo));
    }

    @PostMapping("/rank/diffAnalysis")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER290)
    @ApiOperation(value = "运营分析报告-车辆排名及差异分析", authorizations = {@Authorization(value = "Auth-Token")})
    public Response<OperationAnalysisDTO> rankDiffAnalysis(@RequestBody @Validated OperationAnalysisQueryVo vo) throws ExecutionException, InterruptedException {
        return ResponseHelper.createSuccessResponse(analysisService.rankDiffAnalysis(vo));
    }
}
```

## 节油管理

### 数据库

```sql
`m_route`
`m_station`
`m_route_station`
`fuel_efficient_monitor_head`
`fuel_efficient_monitor_detail`
```

### 涉及功能

```java
/**
 * smart-team-core
 * 入口 controoler
 */
@Api(tags = "节油方案")
@RestController
@RequestMapping("/fuel/efficient")
public class FuelEfficientController {
    @GetMapping("/list")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("节油方案列表")
    public Response<PageInfo<FuelEfficientDTO>> list(
        @RequestParam(value = "fuelEfficientName", required = false) String fuelEfficientName, PageCommon pageCommon) {
        return ResponseHelper.createSuccessResponse(fuelEfficientService.list(fuelEfficientName, pageCommon));
    }

    @PostMapping("/add")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("新增节油班线  前端可能没有传班线的id 后端判断保存之后在提交")
    public Response<Object> addFuelEfficient(@Valid @RequestBody RouteAddVO vo) {
        fuelEfficientService.addFuelEfficient(vo);
        return ResponseHelper.createSuccessResponse();
    }

    @GetMapping("/delete/{id}")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("删除")
    public Response<Object> deleteFuelEfficient(@PathVariable Integer id) {
        fuelEfficientService.deleteFuelEfficient(id);
        return ResponseHelper.createSuccessResponse();
    }

    @GetMapping("/find/{id}")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("查看详情")
    public Response<FuelEfficientDTO> findById(@PathVariable Integer id) {
        return ResponseHelper.createSuccessResponse(fuelEfficientService.findById(id));
    }

    @PostMapping("/update")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("编辑节油班线  前端可能没有传班线的id 后端判断保存之后在提交")
    public Response<Object> updateFuelEfficient(@Valid @RequestBody RouteUpdateVO vo) {
        fuelEfficientService.updateFuelEfficient(vo);
        return ResponseHelper.createSuccessResponse();
    }

    @PostMapping("/car/monitor")
    @ApiVersion(group = {ApiVersionConstant.FLEET_VER321, ApiVersionConstant.FLEET_VER333})
    @ApiOperation("开始监控")
    public Response<Object> carMonitor(@RequestBody FuelEfficientMonitorVO vo) {
        fuelEfficientService.carMonitor(vo);
        return ResponseHelper.createSuccessResponse();
    }

    @GetMapping("/list/all/route")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER321)
    @ApiOperation("获取方案列表")
    public Response<List<FuelEfficientRouteDTO>> listAllRoute() {
        return ResponseHelper.createSuccessResponse(fuelEfficientService.listAllRoute());
    }

    @PostMapping("/route/analysis")
    @ApiVersion(group = {ApiVersionConstant.FLEET_VER321, ApiVersionConstant.FLEET_VER333})
    @ApiOperation("线路分析")
    public Response<FuelEfficientRouteAnalysisDTO> fuelEfficientRouteAnalysis(
        @RequestBody FuelEfficientRouteAnalysisVO vo) {
        return ResponseHelper.createSuccessResponse(fuelEfficientService.fuelEfficientRouteAnalysis(vo));
    }

    // ====================================== 线路节油监控 ==================================================
    @PostMapping("/monitor/list")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER333)
    @ApiOperation("节油方案监控列表")
    public Response<PageInfo<FuelEfficientMonitorDTO>> monitorList(@RequestBody FuelEfficientMonitorQueryVO vo) {
        return ResponseHelper.createSuccessResponse(fuelEfficientService.monitorList(vo));
    }

    @GetMapping("/cancel/monitor/{monitorId}")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER333)
    @ApiOperation("节油方案监控-停止监测")
    public Response<Object> updateState(@PathVariable Integer monitorId) {
        fuelEfficientService.updateState(monitorId);
        return ResponseHelper.createSuccessResponse();
    }

    @GetMapping("/check/monitor/{carId}")
    @ApiVersion(group = ApiVersionConstant.FLEET_VER333)
    @ApiOperation("节油方案监控-监控前检查")
    public Response<Object> checkTruckMonitor(@PathVariable Integer carId) {
        fuelEfficientService.checkTruckMonitor(carId);
        return ResponseHelper.createSuccessResponse();
    }
    // ====================================== 线路节油监控 ==================================================
}

/**
 * smart-team-core
 * 监控代码
 */
@Slf4j
@Component("electricFenceEventListener")
public class ElectricFenceEventListener implements DisposableBean {
    // 针对监控进出围栏报警进行监控逻辑
}
```

## flink 车辆报警

### 涉及项目

smartlink-route-monitor-stream
    monitor-stream-core
        vehicle
            com.smartlink.route.monitor.stream.VehicleStream.java // 超时停车、超速告警、油耗监控

smart-team-core
    com.faw.smart.team.adaptor.kafka.receiver.OilChangeReceiver.java // 监听油耗监控数据

## gateway

项目地址

```shell
git clone http://w-liufei@192.168.28.114:8080/a/SMART/smart-team-gateway && (cd smart-team-gateway && mkdir -p .git/hooks && curl -Lo `git rev-parse --git-dir`/hooks/commit-msg http://w-liufei@192.168.28.114:8080/tools/hooks/commit-msg; chmod +x `git rev-parse --git-dir`/hooks/commit-msg)
```