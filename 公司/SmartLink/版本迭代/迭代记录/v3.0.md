# v3.2

### 需求信息

```shell
# Web 原型
https://s4s4ra.axshare.com/#id=0su370&p=%E7%89%88%E6%9C%AC%E9%9C%80%E6%B1%82%E5%88%97%E8%A1%A8-%E5%90%89%E4%B8%87%E5%BA%B7&g=1

# app 原型
https://modao.cc/app/2d73ef52992446cae43310635e629affcb5d766f
```

```sql
CREATE TABLE faw_jf_maintain
(
    id                    VARCHAR(20) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '主键'
        PRIMARY KEY,
    car_no                VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '车牌号',
    chassis_no            VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '底盘号',
    vin_code              VARCHAR(20) DEFAULT ''                 NOT NULL COMMENT 'v码',
    distance_next_mileage VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '距离下次保养里程',
    maintain_project      VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '保养项目（万公里）',
    maintain_type         VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '保养类型',
    maintain_sub_type     VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '保养小类型',
    next_need_mileage     VARCHAR(16) DEFAULT ''                 NOT NULL COMMENT '下次应保养里程',
    create_time           TIMESTAMP   DEFAULT CURRENT_TIMESTAMP  NOT NULL,
    update_time           TIMESTAMP   DEFAULT CURRENT_TIMESTAMP  NOT NULL ON UPDATE CURRENT_TIMESTAMP
)
    COMMENT '解放行保养数据(计算后的数据)';

CREATE INDEX faw_jf_maintain_pk
    ON faw_jf_maintain (vin_code);

alter table trip_sync add merge_id tinyint default 0 not null comment '合并id';

CREATE TABLE smart_team.trip_sync_merge
(
    trip                            BIGINT                                    NOT NULL COMMENT '行程号',
    start_time                      TIMESTAMP   DEFAULT CURRENT_TIMESTAMP     NOT NULL COMMENT '行程开始时间',
    end_time                        TIMESTAMP   DEFAULT '0000-00-00 00:00:00' NOT NULL COMMENT '行程结束时间',
    terminal_id                     BIGINT                                    NOT NULL COMMENT '终端号',
    trip_mileage                    INT                                       NOT NULL COMMENT '行程里程，单位：m',
    trip_fuel                       INT                                       NOT NULL COMMENT '行程油耗，单位：ml',
    trip_duration                   INT                                       NOT NULL COMMENT '行程时间，单位：s',
    fuel100km                       INT                                       NOT NULL COMMENT '百公里油耗，单位:L/100KM，100*tripFuel/tripMileage',
    drive_avg_speed                 INT                                       NOT NULL COMMENT '驾驶平均速度：时间段里程/（运行时长 - 怠速时长）* 3600，单位km/h',
    idle_parking_time3b             BIGINT                                    NOT NULL COMMENT '怠速时长，单位：s',
    idle_parking_fuel_consumption3b DOUBLE(11, 2)                             NOT NULL COMMENT '怠速油耗，单位：ml',
    route_start_lat02               BIGINT                                    NULL COMMENT '车辆行程开始纬度 以度为单位的纬度值乘以 10 的 6 次方，精确到百万分之一度',
    route_start_lon02               BIGINT                                    NULL COMMENT '车辆行程开始经度 以度为单位的纬度值乘以 10 的 6 次方，精确到百万分之一度',
    start_address                   VARCHAR(512)                              NULL COMMENT '开始地址',
    route_start_mileage             DOUBLE(11, 2)                             NULL COMMENT '车辆行程开始里程 单位：m',
    route_start_fuel                DOUBLE(11, 2)                             NULL COMMENT '车辆行程开始油耗 单位：ml',
    route_end_lat02                 BIGINT                                    NULL COMMENT '车辆行程结束纬度 以度为单位的纬度值乘以 10 的 6 次方，精确到百万分之一度',
    route_end_lon02                 BIGINT                                    NULL COMMENT '车辆行程结束经度 以度为单位的纬度值乘以 10 的 6 次方，精确到百万分之一度',
    end_address                     VARCHAR(512)                              NULL COMMENT '结束地址',
    route_end_mileage               DOUBLE(11, 2)                             NULL COMMENT '车辆行程结束里程 单位：m',
    route_end_fuel                  DOUBLE(11, 2)                             NULL COMMENT '车辆行程结束油耗 单位：ml',
    pdt                             INT                                       NULL COMMENT '日期',
    driver_no                       VARCHAR(50) DEFAULT ''                    NULL COMMENT '司机编号',
    driver_name                     VARCHAR(50) DEFAULT ''                    NULL COMMENT '司机姓名',
    driver_tel                      VARCHAR(50) DEFAULT ''                    NULL COMMENT '司机手机号',
    id                              BIGINT AUTO_INCREMENT COMMENT '记录标识',
    merge_id                        BIGINT(20)     DEFAULT 0                     NOT NULL COMMENT '合并id',
    PRIMARY KEY (id)
)
    COMMENT '行程同步合并表';

CREATE INDEX idx_merge_id ON trip_sync_merge(merge_id);

ALTER TABLE b_day_statistics_2020_10 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2020_11 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2020_12 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_01 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_02 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_03 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_04 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_05 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_06 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_07 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_08 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_09 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_10 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_11 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2021_12 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2022_01 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2022_02 DROP COLUMN `trip_score`;
ALTER TABLE b_day_statistics_2022_03 DROP COLUMN `trip_score`;

delimiter //
DROP PROCEDURE IF EXISTS smart_team.DayStatisticsSpliteTable;
CREATE PROCEDURE smart_team.DayStatisticsSpliteTable()
BEGIN

    SET @nextMonth = DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), '%Y_%m');
    SET @create_table = concat(
            "CREATE TABLE IF NOT EXISTS b_day_statistics_", @nextMonth,
            "(
              `id` int(11) NOT NULL AUTO_INCREMENT,
              `car_id` int(11) default 0 not null comment '车辆主键',
              `odo_mileage` double default 0 not null comment '总里程',
              `trip_mileage` double default 0 not null comment '根据0200结果精准后的里程 单位:米',
              `avg_speed` double default 0 not null comment '平均速度单位:(100*M/S)',
              `drive_avg_speed` double default 0 not null comment '驾驶平均速度 单位:米/秒',
              `idle_fuel` double default 0 not null comment '怠速油耗 单位:毫升',
              `oil` double default 0 not null comment '根据0200结果精准后的油耗 单位:毫升',
              `fuel100km` double default 0 not null comment '百公里油耗，单位:升/100千米',
              `trip_duration` double default 0 not null comment '行程时长 单位:秒 （行程结束时间-开始时间）=引擎工作时长',
              `idle_duration` double default 0 not null comment '怠速时长 单位:秒',
              `brake_number` INT(11) comment '刹车次数',
              `brake_times` DOUBLE comment '刹车时间',
              `brake_mil` DOUBLE comment '刹车里程/单位m',
              `trip_urea` double default 0 not null comment '累计尿素喷射量,单位：g',
              `vehicle_utilization_per` double default 0 not null comment '车辆利用率环比上月 单位% 保留两位小数',
              `fuel_consumption_per` double default 0 not null comment '平均百公里能耗环比上月 单位% 保留两位小数',
              `day` varchar(20) default '' not null comment '固化日期',
              `create_time` datetime DEFAULT CURRENT_TIMESTAMP not null,
              `update_time` datetime DEFAULT CURRENT_TIMESTAMP not null ON UPDATE CURRENT_TIMESTAMP,
              `trip_cost` double default 0 not null comment '行驶成本',
              PRIMARY KEY (`id`),
              UNIQUE KEY `IDX_car_id_day` (`car_id`,`day`),
              KEY `IDX_CAR_ID` (`car_id`) USING BTREE,
              KEY `IDX_DAY` (`day`) USING BTREE
            ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
            ");
    PREPARE stmt FROM @create_table;
    EXECUTE stmt;
END //
delimiter ;

DROP INDEX idx_driver_no ON a_message_2019_07;
DROP INDEX idx_driver_no ON a_message_2019_08;
DROP INDEX idx_driver_no ON a_message_2019_09;
DROP INDEX idx_driver_no ON a_message_2019_10;
DROP INDEX idx_driver_no ON a_message_2019_11;
DROP INDEX idx_driver_no ON a_message_2019_12;
DROP INDEX idx_driver_no ON a_message_2020_01;
DROP INDEX idx_driver_no ON a_message_2020_02;
DROP INDEX idx_driver_no ON a_message_2020_03;
DROP INDEX idx_driver_no ON a_message_2020_04;
DROP INDEX idx_driver_no ON a_message_2020_05;
DROP INDEX idx_driver_no ON a_message_2020_06;
DROP INDEX idx_driver_no ON a_message_2020_07;
DROP INDEX idx_driver_no ON a_message_2020_08;
DROP INDEX idx_driver_no ON a_message_2020_09;
DROP INDEX idx_driver_no ON a_message_2020_10;
DROP INDEX idx_driver_no ON a_message_2020_11;
DROP INDEX idx_driver_no ON a_message_2020_12;
DROP INDEX idx_driver_no ON a_message_2021_01;
DROP INDEX idx_driver_no ON a_message_2021_02;
DROP INDEX idx_driver_no ON a_message_2021_03;
DROP INDEX idx_driver_no ON a_message_2021_04;
DROP INDEX idx_driver_no ON a_message_2021_05;
DROP INDEX idx_driver_no ON a_message_2021_06;
DROP INDEX idx_driver_no ON a_message_2021_07;
DROP INDEX idx_driver_no ON a_message_2021_08;
DROP INDEX idx_driver_no ON a_message_2021_09;
DROP INDEX idx_driver_no ON a_message_2021_10;
DROP INDEX idx_driver_no ON a_message_2021_11;
DROP INDEX idx_driver_no ON a_message_2021_12;
DROP INDEX idx_driver_no ON a_message_2022_01;
DROP INDEX idx_driver_no ON a_message_2022_02;
DROP INDEX idx_driver_no ON a_message_2022_03;
DROP INDEX idx_driver_no ON a_message_2022_04;

DROP INDEX idx_alarm_time ON a_message_2019_07;
DROP INDEX idx_alarm_time ON a_message_2019_08;
DROP INDEX idx_alarm_time ON a_message_2019_09;
DROP INDEX idx_alarm_time ON a_message_2019_10;
DROP INDEX idx_alarm_time ON a_message_2019_11;
DROP INDEX idx_alarm_time ON a_message_2019_12;
DROP INDEX idx_alarm_time ON a_message_2020_01;
DROP INDEX idx_alarm_time ON a_message_2020_02;
DROP INDEX idx_alarm_time ON a_message_2020_03;
DROP INDEX idx_alarm_time ON a_message_2020_04;
DROP INDEX idx_alarm_time ON a_message_2020_05;
DROP INDEX idx_alarm_time ON a_message_2020_06;
DROP INDEX idx_alarm_time ON a_message_2020_07;
DROP INDEX idx_alarm_time ON a_message_2020_08;
DROP INDEX idx_alarm_time ON a_message_2020_09;
DROP INDEX idx_alarm_time ON a_message_2020_10;
DROP INDEX idx_alarm_time ON a_message_2020_11;
DROP INDEX idx_alarm_time ON a_message_2020_12;
DROP INDEX idx_alarm_time ON a_message_2021_01;
DROP INDEX idx_alarm_time ON a_message_2021_02;
DROP INDEX idx_alarm_time ON a_message_2021_03;
DROP INDEX idx_alarm_time ON a_message_2021_04;
DROP INDEX idx_alarm_time ON a_message_2021_05;
DROP INDEX idx_alarm_time ON a_message_2021_06;
DROP INDEX idx_alarm_time ON a_message_2021_07;
DROP INDEX idx_alarm_time ON a_message_2021_08;
DROP INDEX idx_alarm_time ON a_message_2021_09;
DROP INDEX idx_alarm_time ON a_message_2021_10;
DROP INDEX idx_alarm_time ON a_message_2021_11;
DROP INDEX idx_alarm_time ON a_message_2021_12;
DROP INDEX idx_alarm_time ON a_message_2022_01;
DROP INDEX idx_alarm_time ON a_message_2022_02;
DROP INDEX idx_alarm_time ON a_message_2022_03;
DROP INDEX idx_alarm_time ON a_message_2022_04;

DROP INDEX idx_vehicle_tid ON a_message_2019_07;
DROP INDEX idx_vehicle_tid ON a_message_2019_08;
DROP INDEX idx_vehicle_tid ON a_message_2019_09;
DROP INDEX idx_vehicle_tid ON a_message_2019_10;
DROP INDEX idx_vehicle_tid ON a_message_2019_11;
DROP INDEX idx_vehicle_tid ON a_message_2019_12;
DROP INDEX idx_vehicle_tid ON a_message_2020_01;
DROP INDEX idx_vehicle_tid ON a_message_2020_02;
DROP INDEX idx_vehicle_tid ON a_message_2020_03;
DROP INDEX idx_vehicle_tid ON a_message_2020_04;
DROP INDEX idx_vehicle_tid ON a_message_2020_05;
DROP INDEX idx_vehicle_tid ON a_message_2020_06;
DROP INDEX idx_vehicle_tid ON a_message_2020_07;
DROP INDEX idx_vehicle_tid ON a_message_2020_08;
DROP INDEX idx_vehicle_tid ON a_message_2020_09;
DROP INDEX idx_vehicle_tid ON a_message_2020_10;
DROP INDEX idx_vehicle_tid ON a_message_2020_11;
DROP INDEX idx_vehicle_tid ON a_message_2020_12;
DROP INDEX idx_vehicle_tid ON a_message_2021_01;
DROP INDEX idx_vehicle_tid ON a_message_2021_02;
DROP INDEX idx_vehicle_tid ON a_message_2021_03;
DROP INDEX idx_vehicle_tid ON a_message_2021_04;
DROP INDEX idx_vehicle_tid ON a_message_2021_05;
DROP INDEX idx_vehicle_tid ON a_message_2021_06;
DROP INDEX idx_vehicle_tid ON a_message_2021_07;
DROP INDEX idx_vehicle_tid ON a_message_2021_08;
DROP INDEX idx_vehicle_tid ON a_message_2021_09;
DROP INDEX idx_vehicle_tid ON a_message_2021_10;
DROP INDEX idx_vehicle_tid ON a_message_2021_11;
DROP INDEX idx_vehicle_tid ON a_message_2021_12;
DROP INDEX idx_vehicle_tid ON a_message_2022_01;
DROP INDEX idx_vehicle_tid ON a_message_2022_02;
DROP INDEX idx_vehicle_tid ON a_message_2022_03;
DROP INDEX idx_vehicle_tid ON a_message_2022_04;

CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_07 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_08 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_09 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_10 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_11 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2019_12 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_01 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_02 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_03 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_04 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_05 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_06 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_07 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_08 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_09 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_10 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_11 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2020_12 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_01 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_02 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_03 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_04 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_05 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_06 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_07 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_08 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_09 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_10 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_11 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2021_12 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2022_01 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2022_02 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2022_03 (vehicle_tid, alarm_time, message_type);
CREATE INDEX idx_vehicle_tid_alarm_time_message_type_index ON a_message_2022_04 (vehicle_tid, alarm_time, message_type);

INSERT INTO smart_team.s_dictionary (delete_flag, dict_code, dict_name, dict_type_code, remarks)
VALUES (0, '8', '保养提醒', 'AFFAIRS_ALARM_TYPE', '');
```
