> 小店优化版本

d2c-tc-app 结束
d2c-ta-cash-app 结束
d2c-tc-task 结束
d2c-retail-plugin
d2c-retail-mysql

> 商品类型版本

d2c-tc-app
d2c-tc-mysql
d2c-ta-cash-app
d2c-tc-cash-mysql
trade-view

https://blog.csdn.net/get_set/article/details/79480172
https://www.cnblogs.com/yuanrw/p/10050509.html

> 钱包

账号 15195862767
密码 123456
店铺 钱包1期账号(A1069051)

1. 人脸识别优先级降低，有限保证前三个.
4. 现有用户开户的注册，现有用户有店铺余额转到钱包余额.
    1. 上线默认注册-开户

认证

https://org.modao.cc/app/287149853fe7084f3ebd4814a39a5ecb19597e5d
https://org.modao.cc/app/811040fb0b42d36c4de42c24bd90a211fb655cfb

钱包上线总结

1. 因为在测试环境过程中需要改到数据那么一定要把 SQL 记录下来.因为在上线的时候可能就会漏掉.
2. 日志打全，尽量能捕捉到一些重要的细节.

二期

1. 需要汇款表增加一个退款状态字段(汇款支付、POS 支付退款搁浅)
2. 新增 sysId 0111

3. 多个 appId 支持

> SN 绑定终端

```
'0850',
'0820',
'0802',
'0845',
'0851',
'0810',
'0844',
'0842',
'0843',
'0901'


/**
 * 指令。
 * 生成动态二维码(QR_ORDER_CREATE) 预下单(支持app、小程序)(QR_ORDER_CREATE_APP) 查询商户订单(QR_ORDER_QUERY) 刷新商户订单(QR_ORDER_REFRESH) 扫码退货受理(QR_REFUND_ORDER)
 * 撤销交易(QR_REVERSE)
 * 提交刷卡支付(QR_MICROPAY) 统一预下单(QR_ORDER_PRE_ORDERPAY)(支持 NATIVE&JSAPI) 创建已绑定商户的Q码(静态码)(QR_ORDER_BIND_CODE_CREATE) 获取userId API(银联JS支付)(QR_UNIONPAY_GET_USERID) 获取银联微信openId(QR_UNIONPAY_GET_OPENID)
 */
'0850' 微信支付(小程序)                  ------------------------> 预下单
'0820' 支付宝手机网站支付 JSAPI          ------------------------> 预下单
'0802' 微信支付(公众号) JSAPI            ------------------------> 预下单
'0845' 微信支付(云订货专用公众号) JSAPI  ------------------------> 预下单
'0851' 微信支付(小程序) JSAPI            ------------------------> 预下单

'0810' 微信支付扫码                      ------------------------> 用户主扫
'0844' 支付宝支付扫码                    ------------------------> 用户主扫

'0842' 微信刷卡支付                      ------------------------> 商户主扫
'0843' 支付宝当面付(条码)                ------------------------> 商户主扫
'0901' 闪付B扫C（拉卡拉）                ------------------------> 商户主扫
```

> app 聚合支付

```sql
-- 0813 API@EWALLET@WECHATAPP
-- 0841 API@EWALLET@ALIPAYAPP

INSERT INTO PAY_GATE (GATE_CODE, GATE_NAME, GATE_SWITCH, CUSTOM_PAY, IS_LAZY_FLG, ORIGINAL_REFUND_FLAG)
VALUES ('LKLLED000134', '拉卡拉分账', 1, 1, 0, 0);

INSERT INTO PAY_GATE_BANKS (GATE_BANK_ID, GATE_CODE, BANK_CODE, BANK_ID, GATE_BANK_SWITCH)
VALUES (SEQ_GATE_BANK_ID.nextval, 'LKLLED000134', '0813', 'API@EWALLET@WECHATAPP', '1');

INSERT INTO PAY_GATE_BANKS (GATE_BANK_ID, GATE_CODE, BANK_CODE, BANK_ID, GATE_BANK_SWITCH, P2B_TYPE)
VALUES (SEQ_GATE_BANK_ID.nextval, 'LKLLED000134', '0841', 'API@EWALLET@ALIPAYAPP', '1', '4');

INSERT INTO PAY_USER_GATE_BANK (USER_GATE_BANK_ID, ACCT_ID, BANK_CODE, GATE_CODE, RATE_CONF_ID, BANK_GATE_SWITCH)
VALUES (SEQ_PAY_USER_GATE_BANK_ID.nextval, (SELECT psp.USER_ID FROM PAY_SYS_PROFILE psp WHERE psp.SYSTEM_ID = '30'),
        '0813', 'LKLLED000134', 10220, 1);

INSERT INTO PAY_USER_GATE_BANK (USER_GATE_BANK_ID, ACCT_ID, BANK_CODE, GATE_CODE, RATE_CONF_ID, BANK_GATE_SWITCH)
VALUES (SEQ_PAY_USER_GATE_BANK_ID.nextval, (SELECT psp.USER_ID FROM PAY_SYS_PROFILE psp WHERE psp.SYSTEM_ID = '30'),
        '0841', 'LKLLED000134', 10220, 1);

INSERT INTO PAY_USER_GATE_KEY (USER_GATE_KEY_ID, GATE_CODE, ACCOUNT_NO, ACCOUNT, PAY_KEY, QUERY_KEY, PAY_PRIVATE_KEY,
                               STATE)
VALUES (SEQ_PAY_USER_GATE_KEY_ID.nextval, 'LKLLED000134', '872290021025000', 'wx9e465c7f315fe3de', '', '090857',
        './conf/872290021025000.p12', 1);

INSERT INTO PAY_USER_GATE_CONF (USER_GATE_CONF_ID, GATE_CODE, ACCT_ID, USER_GATE_KEY_ID, RATE_CONF_ID, GATE_SWITCH,
                                AUDIT_STATE, ORIGINAL_REFUND_FLAG)
VALUES (SEQ_PAY_USER_GATE_CONF_ID.nextval, 'LKLLED000134',
        (SELECT psp.USER_ID FROM PAY_SYS_PROFILE psp WHERE psp.SYSTEM_ID = 30),
        (SELECT USER_GATE_KEY_ID
         FROM PAY_USER_GATE_KEY
         WHERE GATE_CODE = 'LKLLED000134' AND ACCOUNT_NO = '872290021025000'),
        10220, 1, 1, 1);

INSERT INTO PAY_GATE_CONF(GATE_CODE, GATE_CLASS_NAME, PAY_URL, CALLBACK_URL, NOTIFY_URL, SIGN_TYPE)
VALUES ('LKLLED000134', 'com.qianmi.acct.gateway.adaptor.paygate.proxy.instance.lkl.LakalaLedgerPayService',
        'https://intpay.lakala.com/mrpos/cashier', 'http://paycallback.1000.com.test1.ck/callback/jd/showPayResult/',
        'http://paycallback.1000.com/callback/lakala/ledger/account/pay/callback', 'MD5');
```

> 退款优化

- 结算前部分退款
- 部分退款计算手续费
- 退款佣金校验、由订单业务方传入
- 结算后部分退款
- 结算后全额退款
- 财务对账报表优化

> 江西银行

测试环境地址
http://wxtest.jx-bank.com/pos/IMP-CPos/
https://wxtest.jx-bank.com/pos/IMP-CPos/

测试商户号：448581220000006
测试商户端公钥：448581220000006_pubkey.cert
测试商户端私钥：448581220000006_prikey.cert
测试银行端公钥：jxbanktest_pubkey.cert
测试商户apikey:1234567890ABCDEFGHIJ1234567890AB
终端号: 58120422

> 交易管理

1. gateway 升级了 mybatis 上线一定要修改 application.properties!!!

```sql
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0205, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0213, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0214, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0215, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0217, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0218, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0219, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0737, '京东支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0440, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(1218, '银联');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(1219, '银联');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(1224, '银联');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0847, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0204, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0210, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0432, '网银在线');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0129, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0104, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0105, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0106, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0110, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0113, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0114, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0125, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0127, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0126, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0128, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0107, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0137, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0221, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0145, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0206, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0207, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0211, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0139, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0119, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0120, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0121, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0122, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0405, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0849, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0738, '易宝支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0739, '易宝支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0740, '易宝支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0741, '易宝支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0743, '易宝支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0321, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0318, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0309, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0304, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0302, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0305, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0306, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0307, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0308, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0310, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0311, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0322, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0903, '拉卡拉POS');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0904, '拉卡拉POS');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0174, '其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0852, '微信支付');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES(0866, '微信支付');

INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYYOP0001','易宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYUNIPOSPRE','银联商务');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZFB0005','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('YOP0001','易宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZFB0002','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLPOS000133','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLEDWX0001','拉卡拉网金');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0006','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYLKL0001','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYYJF0001','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0002','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0004','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYZFB0002','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZFB0003','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYCB0001','网银在线');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYSFT0001','盛付通');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYUNIPOSSUF','银联商务');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('WX0001','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYZFB0006','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLED000134','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZFB0004','支付宝');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYCNCBPOS','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYICBC0003','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLEDWX0004','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYCBP0002','京东');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0007','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYTB0001','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0003','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLEDWX0006','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLEDWX0005','拉卡拉');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYJK0001','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ABCE00002','其他');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('ZDYWX0009','微信');
INSERT INTO PAY_BANK_TYPE_CHANNEL(BANK_CODE,BANK_NAME) VALUES('LKLLEDWX0003','拉卡拉');
```

> 中原银行

wx3f84ddd76ba9897a 南京千米云信息技术有限公司
https://218.28.220.236:9072

小程序测试数据
appid:wx73e0834f7accfe93
开发测试环境：986494101000138
U8测试环境：986507102000126
U6环境：986507102000184
千米U8测试环境商户号：986410102001621 微信下单接口里 payChannel 字段送 WXPAY07

```java
@Data
@Builder
public class HttpsHelper {

    private static final String UTF8_CODING = "UTF-8";
    private static final String STORE_TYPE_JKS = "JKS";
    private static final String SSL_PROTO_TLS = "TLS";
    private static final String HTTPS = "https";
    private static final String CONTENT_TYPE = "Content-Type";
    private static final String CONTENT_TYPE_XML = "text/xml";
    private HttpClient HTTP_CLIENT;
    private String url;
    private String clientKeyStoreFile;
    private String clientKeyStorePwd;
    private String clientKeyPwd;
    private String clientTrustKeyStoreFile;
    private String clientTrustKeyStorePwd;

    public HttpsHelper createHttpClient() throws Exception {
        HTTP_CLIENT = getHttpClient();
        return this;
    }

    public HttpClient getHttpClient() throws Exception {
        //KeyStore clientKeyStore = KeyStore.getInstance(STORE_TYPE_JKS);
        //clientKeyStore.load(new FileInputStream(clientKeyStoreFile), clientKeyStorePwd.toCharArray());
        //KeyManagerFactory keyManagerFactory = KeyManagerFactory
        //        .getInstance(KeyManagerFactory.getDefaultAlgorithm());
        //keyManagerFactory.init(clientKeyStore, clientKeyPwd.toCharArray());
        //// XXX 跳过服务端证书认证操作.
        //KeyStore clientTrustKeyStore = KeyStore.getInstance(STORE_TYPE_JKS);
        //clientTrustKeyStore
        //        .load(new FileInputStream(clientTrustKeyStoreFile), clientTrustKeyStorePwd.toCharArray());
        //TrustManagerFactory trustManagerFactory = TrustManagerFactory
        //        .getInstance(TrustManagerFactory.getDefaultAlgorithm());
        //trustManagerFactory.init(clientTrustKeyStore);
        //
        //SSLContext sslContext = SSLContext.getInstance(SSL_PROTO_TLS);
        //// XXX 跳过服务端证书认证操作.
        //sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), new SecureRandom());
        //sslContext.init(keyManagerFactory.getKeyManagers(), new TrustManager[]{getX509TrustManager()},
        //        new SecureRandom());

        KeyStore clientKeyStore = KeyStore.getInstance(STORE_TYPE_JKS);
        clientKeyStore.load(new FileInputStream(clientKeyStoreFile), clientKeyStorePwd.toCharArray());
        // XXX: 跳过服务端证书认证操作.
        final SSLContext sslContext = SSLContexts.custom()
                .loadKeyMaterial(clientKeyStore, clientKeyPwd.toCharArray())
                .loadTrustMaterial((x509Certificates, s) -> true).build();
        Registry<ConnectionSocketFactory> socketFactoryRegistry = RegistryBuilder.<ConnectionSocketFactory>create()
                .register(HTTPS, new SSLConnectionSocketFactory(sslContext,
                        new String[]{"SSLv2Hello", "SSLv3", "TLSv1", "TLSv1.1", "TLSv1.2"}, null,
                        getHostnameVerifier())).build();
        PoolingHttpClientConnectionManager connManager = new PoolingHttpClientConnectionManager(
                socketFactoryRegistry);
        return HttpClients.custom().setConnectionManager(connManager).build();
    }

    public RestTemplate restTemplate() throws Exception {
        HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(15000);
        factory.setReadTimeout(5000);
        factory.setHttpClient(getHttpClient());
        RestTemplate restTemplate = new RestTemplate(factory);
        List<HttpMessageConverter<?>> messageConverters = restTemplate.getMessageConverters();
        if (CollectionUtils.isEmpty(messageConverters)) {
            return restTemplate;
        }
        // 设置编码
        for (int i = 0; i < messageConverters.size(); i++) {
            HttpMessageConverter<?> httpMessageConverter = messageConverters.get(i);
            if (httpMessageConverter.getClass().equals(StringHttpMessageConverter.class)) {
                messageConverters.set(i, new StringHttpMessageConverter(StandardCharsets.UTF_8));
            }
        }
        return restTemplate;
    }

    public String invokePost(String requestParam) throws Exception {
        HttpPost httpPost = new HttpPost(url);
        RequestConfig requestConfig = RequestConfig.custom().setSocketTimeout(10_000).setConnectTimeout(10_000)
                .build();
        httpPost.setConfig(requestConfig);
        httpPost.addHeader(CONTENT_TYPE, CONTENT_TYPE_XML);
        httpPost.addHeader("DSFID", ZyXmlHelper.CHL_ID_VAL);
        StringEntity postEntity = new StringEntity(requestParam, UTF8_CODING);
        httpPost.setEntity(postEntity);
        HttpResponse response = HTTP_CLIENT.execute(httpPost);
        HttpEntity httpEntity = response.getEntity();
        return EntityUtils.toString(httpEntity, UTF8_CODING);
    }

    private static X509TrustManager getX509TrustManager() {
        return new X509TrustManager() {
            @Override
            public void checkClientTrusted(X509Certificate[] x509Certificates, String s)
                    throws CertificateException {

            }

            @Override
            public void checkServerTrusted(X509Certificate[] x509Certificates, String s)
                    throws CertificateException {

            }

            @Override
            public X509Certificate[] getAcceptedIssuers() {
                return new X509Certificate[0];
            }
        };
    }

    private static HostnameVerifier getHostnameVerifier() {
        return (var1, var2) -> true;
    }
}
```

⭐gateway 是否要接入全链路跟踪？需要接入需要配置 maven、properties 信息。并且将原 pom 中 kafka-clients 依赖去除掉，因为在 trace 项目中已经引入了。生产环境，kafka 连接，在 bugatti 的项目管理中添加对 qianmi_trace_kafka 的依赖.
qianmi.kafka.bootstrap-servers={{dependence.qianmi_trace_kafka.alias.BrokerList}}

```
modified:   acct-micro-gateway-app/pom.xml
modified:   acct-micro-gateway-app/src/main/resources/application.properties
modified:   acct-micro-gateway-core/pom.xml
modified:   pom.xml
```

⭐需要再 payment 处理批量收货结算的情况。[未完成]

> 云分销&B2B- 拉卡拉网关接入

http://www.woshipm.com/pd/3043941.html

接口文档 http://106.14.112.9:5000/wiki/docs/openplatform/openplatform-1cmilomj65m51

测试环境地址：https://test.wsmsd.cn/sit/bps/api/mch/cmd
测试环境联调示例值
appid：1
token：43e99b4a38a748d3932fca9382404b41
secretKey：f6cc7030b8c0ba07a6da488362f2748e
支付回调密钥
订单来源送：OS00000001

标准通知的公私钥

私钥： 00858DDCE78B68BB4490EF6872EC528E4288896ACA53E3CCD7BB1FC2640E215F1D
公钥X：371FB02F8D0BD9EA94948AAE01FD0CE0608F67CC0E4ED818BC6517AEFE192F57
公钥Y：B4C17DD4B11C5FF7E72EB530AB07FEB6AA4FC796DB2E28D6A981E8F4DED483C4

https://gitee.com/ren365880/sm-java/tree/master/com/security
https://www.cnblogs.com/alsodzy/p/9854521.html
https://github.com/hwyqb/SM2_SM3_SM4Encrypt/blob/master/src/main/java/cn/xjfme/encrypt/utils/sm2/SM2SignVerUtils.java

⭐增加配置文件

lkl.led.order.source=OS12
lkl.led.secret.key=f6cc7030b8c0ba07a6da488362f2748e

> 拉卡拉网关优化

生产appid：800000020013000
生产公钥获取url：https://s2.lakala.com/gw/pubcerts?appId=800000020013000

labs主扫支付url：https://s2.lakala.com/labs/txn/labs_order_pre_orderpay
labs关单url：https://s2.lakala.com/labs/txn/labs_order_close
labs被扫支付url：https://s2.lakala.com/labs/txn/labs_order_micropay
labs退款url：https://s2.lakala.com/labs/txn/labs_order_refund
labs动态码url：https://s2.lakala.com/labs/txn/labs_dycode_create
labs订单查询url：https://s2.lakala.com/labs/txn/labs_order_query
订单结算url：https://s2.lakala.com/mrss/ledger/settle_ledger
结算结果查询url：https://s2.lakala.com/mrss/ledger/settle_result_query

⭐增加配置文件

lkl.led.order.salfplatformno=
lkl.led.order.security.appid=
lkl.led.order.security.lkl.pubkey=
lkl.led.order.security.qm.preKey=
lkl.led.order.security.serialno=

gate_conf 请求 url 记得换

分销小程序 bankCode 记得配置

> 对账

https://www.yuque.com/ooc/blog/nglog5
https://docs.qq.com/doc/DTVNNY0NhYVNKaGti?_t=1613702186869

解决方案：业务系统传入收款码交易标识，账务系统根据结算单流水匹配收款码交易
操作步骤
（1）业务系统与账务系统约定收款码交易标识，下单时传入业务标识；
（2）账务系统拿到结算单流水，根据交易流水号匹配交易业务标识；
（3）提供给前端的结算流水查询支持传入只查询“收款码”交易条件。

⭐需要添加系统ID、增加商户费率

⭐需要在刷一次表：增加了封顶费率、退款网关单号字段

> 拉卡拉钱包

钱包交易接口
http://106.14.112.9:5000/wiki/docs/openplatform/openplatform-1cmbhii319p70

```sql
# 生产收银台配置
https://hcacp.lakala.com/web/v1/index.html/?prepayId=***&channelCode=***&token=***&url=***

# 新增支付方式
INSERT INTO PAY_BANK (BANK_CODE, BANK_NAME, BANK_REMARK, BANK_TYPE, BANK_DESC, OPT_TIME, BANK_SWITCH)
VALUES ('0460', '拉卡拉钱包', '拉卡拉钱包', 4, '拉卡拉钱包', sysdate, 1);
```

```sql
-- 生产
-- pay_url=https://s2.lakala.com/labs/txn
-- ext_json=855370
-- ext_remark=b6e861300fc4b9343b6c7d2d851f833a
-- merchantPublicKey=4be077e8f821e4499883e9bc76ae9f43
-- 测试
-- pay_url=https://test.wsmsd.cn/sit/labs/txn
-- ext_json=1
-- ext_remark=43e99b4a38a748d3932fca9382404b41
SELECT *
FROM PAY_GATE_CONF
WHERE GATE_CODE = 'ZDYLKL0002';
```

